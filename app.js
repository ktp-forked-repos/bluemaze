(function(){

var Lamp = illuminated.Lamp
, Light = illuminated.Light
, Vec2 = illuminated.Vec2
, OpaqueObject = illuminated.OpaqueObject
, PolygonObject = illuminated.PolygonObject
, DiscObject = illuminated.DiscObject
, RectangleObject = illuminated.RectangleObject
, Lighting = illuminated.Lighting
, DarkMask = illuminated.DarkMask
;

var supportsColor = $("<input type='color' />")[0].type === "color";

var dirty = true;

var DIST_CLOSE = 10;

var SELECTED_STROKE_FROM = "#115";
var SELECTED_STROKE_TO = "#511";
var HOVER_STROKE = "#667";
var OBJECT_STROKE = "#778";
var SELECTED_STROKE;
setInterval((function(i){
  return function(){
    SELECTED_STROKE = (++i)%2 ? SELECTED_STROKE_FROM: SELECTED_STROKE_TO;
    dirty = true;
  }
}(0)), 300);

var scene;
var mousep = new Vec2();

var mousedown, oldmousedown;
var mousedownItemNew;
var mousedownItem;
var moveItemDelta;

var canvasHashFocus = true;

var buildPoly;
var items = [];
var currentSelect = 0;
var currentToolSelected;

var canvas = document.getElementById("viewport");
var ctx = canvas.getContext("2d");

var $lightorientation = $('canvas.light-orientation');
var $lightcontrols=$(".lightcontrols");
var $objectcontrols=$(".objectcontrols");
var $circlecontrols=$(".circlecontrols");
var $maskcolor = $('input[name=maskcolor]');
var $maskalpha = $('input[name=maskalpha]');
var $lightcolor = $('input[name=lightcolor]');
var $lightalpha = $('input[name=lightalpha]');
var $lightdiffuse = $('input[name=lightdiffuse]');
var $lightsize = $('input[name=lightsize]');
var $lightsamples = $('input[name=lightsamples]');
var $lightdistance = $('input[name=lightdistance]');
var $objectdiffuse = $('input[name=objectdiffuse]');
var $discradius = $('input[name=discradius]');
var $toolbox = $('#toolbox');
var $tools = $toolbox.find("a img");
var $social = $('#social');
var BASE_URL = "http://demo.greweb.fr/illuminated.js";

function init () {
  var obj = {
    "objects":[
      {"instance":"PolygonObject","points":[{"x":749.2736,"y":122.272},{"x":708.3424,"y":172.31040000000002},{"x":678.5376000000001,"y":223.4464},{"x":660.6336000000001,"y":266.5504},{"x":651.9488000000001,"y":294.8544},{"x":642.272,"y":342.8288},{"x":639.3216000000001,"y":371.98720000000003},{"x":638.7552000000001,"y":411.5264},{"x":641.7472,"y":447.9904000000001},{"x":650.4864,"y":493.98400000000004},{"x":663.8112000000001,"y":536.4288},{"x":704.9888000000001,"y":616.3968},{"x":711.2096,"y":625.7088},{"x":723.6352,"y":617.408},{"x":839.1232,"y":540.2368},{"x":860.8832000000001,"y":565.792},{"x":892.6976000000001,"y":593.0304},{"x":926.2112000000002,"y":613.1424000000001},{"x":967.9968000000001,"y":629.2608},{"x":991.8624,"y":634.7392},{"x":1012.2080000000001,"y":637.4560000000001},{"x":1022.384,"y":638.0736},{"x":1022.384,"y":666.9824},{"x":993.3216000000001,"y":664.2432},{"x":960.6880000000001,"y":657.2608},{"x":940.6208000000001,"y":650.7904000000001},{"x":917.856,"y":641.2416000000001},{"x":883.3568,"y":621.6640000000001},{"x":874.0448000000001,"y":615.4432},{"x":861.6,"y":634.0672},{"x":861.6,"y":634.0672},{"x":839.3792,"y":667.3248},{"x":858.0032,"y":679.7728000000001},{"x":880.3456000000001,"y":646.3328000000001},{"x":908.5408,"y":661.6192000000001},{"x":948.5727999999999,"y":677.0688},{"x":990.4448000000001,"y":686.4672},{"x":1022.3808000000001,"y":689.4208},{"x":1022.3808000000001,"y":729.6352},{"x":1044.7808000000002,"y":729.6352},{"x":1044.7808000000002,"y":638.1056},{"x":1069.2576000000001,"y":635.8144000000001},{"x":1085.7504000000001,"y":632.7520000000001},{"x":1115.5776,"y":624.0672},{"x":1150.5856,"y":708.5856},{"x":1171.28,"y":700.0128},{"x":1092.9088,"y":510.80320000000006},{"x":1088.6208,"y":500.4576},{"x":1078.2752,"y":504.74240000000003},{"x":1050.432,"y":512.4224},{"x":1033.5776,"y":513.632},{"x":1022.3776,"y":513.632},{"x":1022.3776,"y":524.832},{"x":1022.3744000000002,"y":524.832},{"x":1022.3744000000002,"y":576.0352},{"x":1044.7744,"y":576.0352},{"x":1044.7744,"y":535.552},{"x":1060.7328000000002,"y":533.3728},{"x":1076.3104,"y":529.2768},{"x":1106.9952,"y":603.3504},{"x":1087.9840000000002,"y":609.1776},{"x":1064.688,"y":613.8432},{"x":1042.1119999999999,"y":615.8816},{"x":1015.5744000000001,"y":615.2704},{"x":974.3584,"y":607.792},{"x":942.9760000000001,"y":596.32},{"x":906.9280000000001,"y":575.6704},{"x":887.2544,"y":560.0256},{"x":875.1776,"y":548.3616000000001},{"x":848.7872,"y":514.7744},{"x":831.0655999999999,"y":480.7168},{"x":822.5632,"y":456.23040000000003},{"x":818.5696,"y":439.6},{"x":814.6688,"y":408.03200000000004},{"x":894.8672000000001,"y":408.03200000000004},{"x":895.7216000000001,"y":416.2208},{"x":902.9696,"y":445.1552},{"x":926.7040000000002,"y":486.144},{"x":950.816,"y":508.8096},{"x":970.1568,"y":520.6944000000001},{"x":959.0976,"y":547.3888000000001},{"x":942.2112000000002,"y":537.8432},{"x":920.5184000000002,"y":521.2192},{"x":897.0528,"y":494.8448000000001},{"x":878.3744000000002,"y":461.1328000000001},{"x":874.0864,"y":450.78400000000005},{"x":853.392,"y":459.36000000000007},{"x":857.6768000000001,"y":469.7056},{"x":868.5248,"y":491.81440000000003},{"x":883.6704,"y":514.3616000000001},{"x":915.2352,"y":546.1024000000001},{"x":935.9328,"y":560.3392},{"x":960.7200000000001,"y":572.7456000000001},{"x":971.0655999999999,"y":577.0336000000001},{"x":975.3504000000001,"y":566.688},{"x":990.6592,"y":529.7312000000001},{"x":990.6592,"y":529.7312000000001},{"x":999.2288000000001,"y":509.0368000000001},{"x":988.8832000000001,"y":504.7488000000001},{"x":964.6976000000001,"y":491.2128},{"x":944.7904000000001,"y":472.832},{"x":923.5904,"y":436.29120000000006},{"x":917.3152,"y":408.0416},{"x":946.3136000000001,"y":408.0416},{"x":948.2784,"y":418.4704},{"x":951.8784,"y":429.54560000000004},{"x":957.1232,"y":440.37760000000003},{"x":967.4368000000001,"y":454.82560000000007},{"x":980.8896000000001,"y":467.28639999999996},{"x":991.8208000000001,"y":474.288},{"x":1011.6992,"y":482.0896},{"x":1033.5808000000002,"y":484.8448000000001},{"x":1061.0688,"y":480.4352},{"x":1087.3344000000002,"y":466.4352},{"x":1108.2528,"y":487.35360000000003},{"x":1116.1728,"y":495.2736},{"x":1124.0928000000001,"y":503.1936},{"x":1132.0128000000002,"y":495.2736},{"x":1148.0224,"y":476.11840000000007},{"x":1155.1008,"y":464.76160000000004},{"x":1157.4368000000002,"y":460.27200000000005},{"x":1184.5088,"y":471.4848},{"x":1184.5088,"y":471.48800000000006},{"x":1205.2032,"y":480.05760000000004},{"x":1205.2032,"y":480.05760000000004},{"x":1279.1136000000001,"y":510.672},{"x":1279.1136000000001,"y":510.672},{"x":1299.8112,"y":519.2448},{"x":1304.096,"y":508.89920000000006},{"x":1313.3984,"y":482.9472},{"x":1318.304,"y":464.89920000000006},{"x":1357.8048,"y":472.7584},{"x":1368.7904,"y":474.94399999999996},{"x":1370.9792000000002,"y":463.9584},{"x":1375.9072,"y":431.1424},{"x":1377.6896000000002,"y":398.37120000000004},{"x":1376.448,"y":366.9408},{"x":1372.3328000000001,"y":335.87840000000006},{"x":1364.9376000000002,"y":303.76640000000003},{"x":1354.432,"y":272.4352},{"x":1338.9408,"y":238.33280000000002},{"x":1319.6128,"y":205.7312},{"x":1313.392,"y":196.41920000000002},{"x":1294.768,"y":208.864},{"x":1294.7712000000001,"y":208.864},{"x":1270.6304,"y":224.99520000000004},{"x":1253.5328000000002,"y":203.53920000000002},{"x":1240.5344000000002,"y":189.6608},{"x":1221.0592000000001,"y":171.86880000000002},{"x":1217.0912,"y":168.62080000000003},{"x":1205.4528,"y":159.79520000000002},{"x":1227.7952000000002,"y":126.352},{"x":1209.1743999999999,"y":113.90719999999999},{"x":1186.8224,"y":147.3632},{"x":1181.4688,"y":144.0992},{"x":1155.9008000000001,"y":130.8256},{"x":1167.0112000000001,"y":104.00639999999999},{"x":1167.0112000000001,"y":104.00639999999999},{"x":1175.5872,"y":83.3088},{"x":1165.2384,"y":79.024},{"x":1134.8608000000002,"y":68.0448},{"x":1103.5744,"y":59.92960000000001},{"x":1069.9808,"y":54.604800000000004},{"x":1040.3744000000002,"y":52.716800000000006},{"x":1003.4592000000001,"y":53.98720000000001},{"x":970.3168000000001,"y":58.588800000000006},{"x":938.6815999999999,"y":66.1408},{"x":901.9520000000001,"y":79.02080000000001},{"x":891.6032,"y":83.30560000000001},{"x":900.176,"y":104.00320000000002},{"x":900.1792,"y":104.00320000000002},{"x":911.2,"y":130.61440000000002},{"x":911.2,"y":130.61440000000002},{"x":919.7728,"y":151.3056},{"x":930.1184000000002,"y":147.0208},{"x":955.0912000000001,"y":138.0864},{"x":980.8416000000002,"y":131.6288},{"x":991.8304,"y":129.44000000000003},{"x":987.456,"y":107.47200000000001},{"x":976.4736000000001,"y":109.6608},{"x":955.8624,"y":114.5504},{"x":931.9872,"y":122.2656},{"x":920.9536,"y":95.632},{"x":946.3263999999999,"y":87.27680000000001},{"x":977.0495999999999,"y":80.13440000000001},{"x":1013.1360000000001,"y":75.728},{"x":1035.1008,"y":75.0688},{"x":1061.0112000000001,"y":76.25280000000001},{"x":1093.04,"y":80.6752},{"x":1110.3680000000002,"y":84.4736},{"x":1146.2432000000001,"y":95.632},{"x":1135.3024000000003,"y":122.04480000000001},{"x":1135.3024000000003,"y":122.04480000000001},{"x":1126.7264,"y":142.7392},{"x":1137.0752,"y":147.0272},{"x":1168.592,"y":162.52480000000003},{"x":1174.3680000000002,"y":166.0096},{"x":1152.2752,"y":199.04000000000002},{"x":1146.0511999999999,"y":208.352},{"x":1155.3632,"y":214.57600000000002},{"x":1186.6944,"y":239.9456},{"x":1215.6544000000001,"y":274.6848},{"x":1231.5968000000003,"y":302.69440000000003},{"x":1157.9008000000001,"y":333.2192},{"x":1157.8976,"y":333.2192},{"x":1137.2032,"y":341.7952},{"x":1141.4912000000002,"y":352.1408},{"x":1148.1472,"y":374.0448},{"x":1150.3808000000001,"y":396.8416},{"x":1150.3808000000001,"y":408.0416},{"x":1172.7808000000002,"y":408.0384},{"x":1172.7776000000001,"y":396.8416},{"x":1171.2896,"y":376.4352},{"x":1166.0064,"y":354.112},{"x":1240.1536,"y":323.39840000000004},{"x":1246.3680000000002,"y":344.05760000000004},{"x":1251.1584,"y":370.0864},{"x":1252.7808000000002,"y":396.83840000000004},{"x":1252.7808000000002,"y":408.0384},{"x":1275.1808,"y":408.0384},{"x":1275.1808,"y":408.0384},{"x":1315.1808,"y":408.0384},{"x":1315.1808,"y":385.64160000000004},{"x":1274.8928,"y":385.64160000000004},{"x":1273.1392,"y":365.36640000000006},{"x":1265.4464,"y":328.7872},{"x":1260.8512,"y":314.8256},{"x":1298.0256000000002,"y":299.4272},{"x":1289.4560000000001,"y":278.7328},{"x":1252.2656,"y":294.1344},{"x":1245.152,"y":280.0704},{"x":1234.6560000000002,"y":262.8032},{"x":1222.72,"y":246.44160000000002},{"x":1204.5696,"y":226.11840000000004},{"x":1176.9632,"y":202.40640000000002},{"x":1192.976,"y":178.44480000000001},{"x":1206.1984,"y":188.65920000000003},{"x":1226.688,"y":207.51999999999998},{"x":1235.5392000000002,"y":217.0144},{"x":1258.4064,"y":246.6144},{"x":1264.6272000000001,"y":255.92640000000003},{"x":1283.2512,"y":243.4816},{"x":1283.2512,"y":243.4816},{"x":1307.0368,"y":227.59040000000002},{"x":1321.9520000000002,"y":254.3584},{"x":1333.4016000000001,"y":280.208},{"x":1346.7872,"y":323.12},{"x":1307.584,"y":330.9184},{"x":1311.9520000000002,"y":352.88640000000004},{"x":1351.1456,"y":345.0912},{"x":1354.448,"y":373.2096},{"x":1355.2704,"y":398.3392},{"x":1353.6032,"y":428.9408000000001},{"x":1350.9248,"y":448.544},{"x":1322.9376000000002,"y":442.97920000000005},{"x":1322.9376000000002,"y":442.97920000000005},{"x":1300.9696000000001,"y":438.608},{"x":1300.9728,"y":438.608},{"x":1261.7376000000002,"y":430.80640000000005},{"x":1257.3664,"y":452.7744},{"x":1296.3296,"y":460.52479999999997},{"x":1287.4272,"y":489.8688},{"x":1213.4432000000002,"y":459.22240000000005},{"x":1220.5568,"y":432.8864},{"x":1223.9808,"y":396.8448},{"x":1223.9808,"y":385.64480000000003},{"x":1201.5808000000002,"y":385.64480000000003},{"x":1201.5808000000002,"y":396.8448},{"x":1198.3680000000002,"y":429.6224},{"x":1192.6944,"y":450.6272},{"x":1166.4704,"y":439.7632},{"x":1166.4704,"y":439.7632},{"x":1145.7728,"y":431.19040000000007},{"x":1141.488,"y":441.5392},{"x":1133.3088,"y":457.6576},{"x":1130.7072,"y":461.73440000000005},{"x":1123.7088,"y":471.12640000000005},{"x":1103.1552,"y":450.57280000000003},{"x":1112.0704,"y":436.512},{"x":1119.0975999999998,"y":417.5584},{"x":1121.5776,"y":396.8352},{"x":1121.5808000000002,"y":385.63200000000006},{"x":1099.1776,"y":385.63200000000006},{"x":1099.1776,"y":396.83200000000005},{"x":1095.8176,"y":417.5808},{"x":1087.7024000000001,"y":433.86560000000003},{"x":1070.4736,"y":451.0464},{"x":1058.4704,"y":457.52320000000003},{"x":1045.9104,"y":461.2672},{"x":1033.5776,"y":462.42879999999997},{"x":1008.4288000000001,"y":457.4208},{"x":986.064,"y":442.016},{"x":973.1360000000001,"y":422.3296},{"x":967.9776,"y":396.83200000000005},{"x":973.664,"y":370.02240000000006},{"x":987.1904000000001,"y":350.4448},{"x":998.6655999999999,"y":341.2672},{"x":1011.6959999999999,"y":334.9504},{"x":1023.7504000000001,"y":331.95520000000005},{"x":1033.5776,"y":331.22880000000004},{"x":1055.0016,"y":334.79040000000003},{"x":1068.2528,"y":341.1136},{"x":1079.9648000000002,"y":350.4448},{"x":1087.8848,"y":358.36480000000006},{"x":1095.8048,"y":350.4448},{"x":1103.7248,"y":342.5248},{"x":1132.0096,"y":314.24},{"x":1116.1728,"y":298.40000000000003},{"x":1087.3727999999999,"y":327.20000000000005},{"x":1074.9824,"y":319.136},{"x":1067.2768,"y":315.4816},{"x":1053.3344000000002,"y":311.0624},{"x":1044.784,"y":309.5552},{"x":1044.784,"y":229.24800000000002},{"x":1067.5616,"y":232.256},{"x":1087.3984,"y":237.6544},{"x":1072.2207999999998,"y":274.29760000000005},{"x":1092.9184000000002,"y":282.8672},{"x":1108.1056,"y":246.2016},{"x":1129.4624000000001,"y":258.8288},{"x":1152.3776,"y":278.0448},{"x":1160.2975999999999,"y":285.9648},{"x":1176.1376,"y":270.1248},{"x":1168.2176,"y":262.2048},{"x":1145.3824000000002,"y":242.6656},{"x":1110.1728,"y":222.416},{"x":1067.5808000000002,"y":209.44960000000003},{"x":1044.7808000000002,"y":206.80640000000005},{"x":1044.7808000000002,"y":177.632},{"x":1044.784,"y":177.632},{"x":1044.7808000000002,"y":155.232},{"x":1044.7808000000002,"y":126.7136},{"x":1060.208,"y":127.7536},{"x":1075.296,"y":129.712},{"x":1069.7279999999998,"y":157.69600000000003},{"x":1069.7279999999998,"y":157.69600000000003},{"x":1068.048,"y":166.1472},{"x":1067.5456000000001,"y":168.6784},{"x":1067.5456000000001,"y":168.6784},{"x":1065.3632,"y":179.66400000000002},{"x":1076.3488000000002,"y":181.8496},{"x":1097.2160000000001,"y":187.072},{"x":1117.4688,"y":194.32000000000002},{"x":1127.8176,"y":198.608},{"x":1136.3904,"y":177.9136},{"x":1126.0448000000001,"y":173.6288},{"x":1102.9536,"y":165.4112},{"x":1091.6512,"y":162.3264},{"x":1097.3216,"y":133.8144},{"x":1097.3216,"y":133.8144},{"x":1099.0016,"y":125.36},{"x":1099.5040000000001,"y":122.832},{"x":1099.5040000000001,"y":122.832},{"x":1101.6896000000002,"y":111.8464},{"x":1090.7040000000002,"y":109.6608},{"x":1060.1632,"y":105.248},{"x":1033.584,"y":104.03519999999999},{"x":1022.384,"y":104.03200000000002},{"x":1022.3808000000001,"y":126.43520000000001},{"x":1022.384,"y":126.43520000000001},{"x":1022.384,"y":155.5552},{"x":1006.4992000000001,"y":156.7648},{"x":986.448,"y":159.88160000000002},{"x":975.4624,"y":162.0672},{"x":979.8335999999999,"y":184.03520000000003},{"x":990.8191999999999,"y":181.8496},{"x":1014.2080000000001,"y":178.4992},{"x":1022.384,"y":177.952},{"x":1022.384,"y":206.4384},{"x":1022.3808000000001,"y":206.4352},{"x":1022.3808000000001,"y":228.8384},{"x":1022.384,"y":228.8352},{"x":1022.384,"y":309.5488},{"x":1012.416,"y":311.3792},{"x":1004.6112000000002,"y":313.68960000000004},{"x":995.7984000000001,"y":317.3056},{"x":984.5920000000001,"y":323.7024},{"x":971.3568,"y":334.608},{"x":958.2496,"y":351.2928},{"x":951.1264,"y":365.97440000000006},{"x":946.3744000000002,"y":385.63840000000005},{"x":916.7840000000001,"y":385.63840000000005},{"x":894.384,"y":385.63840000000005},{"x":894.384,"y":385.63840000000005},{"x":814.384,"y":385.63840000000005},{"x":814.384,"y":385.63840000000005},{"x":791.984,"y":385.63840000000005},{"x":791.984,"y":385.64160000000004},{"x":763.1840000000001,"y":385.64160000000004},{"x":751.984,"y":385.64160000000004},{"x":740.7808,"y":385.64160000000004},{"x":740.7840000000001,"y":396.8416},{"x":742.6976000000001,"y":430.24},{"x":746.4096,"y":453.9648},{"x":748.5952000000001,"y":464.9504},{"x":770.5632,"y":460.57920000000007},{"x":768.3776,"y":449.5936},{"x":765.4272000000001,"y":431.59680000000003},{"x":763.4432,"y":408.0416},{"x":792.256,"y":408.0416},{"x":796.6016,"y":443.9744},{"x":801.3952,"y":463.66400000000004},{"x":810.3744,"y":489.29920000000004},{"x":826.6944,"y":521.6096},{"x":717.5296000000001,"y":594.5568000000001},{"x":700.7776,"y":564.8896},{"x":691.3984,"y":544.8960000000001},{"x":679.7952,"y":514.5152},{"x":670.3072000000001,"y":480.52160000000003},{"x":698.5728,"y":474.896},{"x":706.2656000000001,"y":502.65280000000007},{"x":715.7696000000001,"y":528.4864},{"x":720.0544,"y":538.832},{"x":740.7488000000001,"y":530.2592},{"x":740.7488000000001,"y":530.2592},{"x":777.7024,"y":514.9504000000001},{"x":769.1328,"y":494.2560000000001},{"x":732.3808,"y":509.4816},{"x":725.3792000000001,"y":488.68800000000005},{"x":718.1600000000001,"y":459.5776},{"x":715.9744000000001,"y":448.59200000000004},{"x":704.9888000000001,"y":450.7808},{"x":665.9584,"y":458.544},{"x":662.9536,"y":436.61120000000005},{"x":660.8928000000001,"y":398.3488},{"x":663.5392,"y":352.944},{"x":670.8384000000001,"y":311.59040000000005},{"x":682.9632,"y":270.5824},{"x":702.5056000000001,"y":225.6096},{"x":727.0368000000001,"y":184.66880000000003},{"x":754.9952000000001,"y":149.0464},{"x":797.1232,"y":108.60160000000002},{"x":817.2544,"y":93.248},{"x":855.6320000000001,"y":150.6752},{"x":861.7376,"y":159.8112},{"x":843.344,"y":174.2656},{"x":826.5440000000001,"y":189.79840000000002},{"x":818.624,"y":197.7184},{"x":834.4639999999999,"y":213.5584},{"x":842.384,"y":205.63840000000002},{"x":859.2959999999999,"y":190.1088},{"x":874.192,"y":178.448},{"x":894.8256,"y":209.3312},{"x":902.4896000000001,"y":220.8},{"x":911.8016,"y":214.57920000000001},{"x":939.4688000000001,"y":198.8864},{"x":950.5056000000001,"y":225.5296},{"x":923.5680000000001,"y":241.4208},{"x":913.4592000000001,"y":249.10720000000003},{"x":898.9567999999999,"y":262.2048},{"x":891.0368000000001,"y":270.1248},{"x":906.8768,"y":285.9648},{"x":914.7968000000001,"y":278.0448},{"x":938.1504000000001,"y":258.5632},{"x":959.1104,"y":246.29760000000002},{"x":970.1504000000001,"y":272.96},{"x":937.8112000000001,"y":295.728},{"x":916.8448000000001,"y":320.96320000000003},{"x":909.7056000000001,"y":333.408},{"x":828.4191999999999,"y":299.7344},{"x":814.656,"y":294.03200000000004},{"x":814.656,"y":294.03200000000004},{"x":777.7024,"y":278.7264},{"x":769.1328,"y":299.42080000000004},{"x":806.3392,"y":314.83200000000005},{"x":799.0784,"y":338.7712},{"x":720.4448000000001,"y":323.1296},{"x":723.6544,"y":310.4352},{"x":736.6272,"y":272.90880000000004},{"x":749.0496,"y":246.608},{"x":760.0192000000001,"y":227.51999999999998},{"x":826.4704,"y":271.92},{"x":826.4704,"y":271.92},{"x":845.0944,"y":284.3648},{"x":851.3184000000001,"y":275.0528},{"x":865.248,"y":256.4352},{"x":878.5824000000001,"y":241.8368},{"x":886.5024,"y":233.91680000000002},{"x":870.6624,"y":218.07680000000002},{"x":862.7424,"y":225.9968},{"x":849.3472,"y":240.53760000000003},{"x":839.1552,"y":253.4528},{"x":772.5632,"y":208.96},{"x":787.7408,"y":189.5168},{"x":806.1728,"y":169.43040000000002},{"x":814.0928,"y":161.5104},{"x":798.2528000000001,"y":145.6704},{"x":790.3328,"y":153.59040000000002},{"x":770.7840000000001,"y":174.81600000000003},{"x":752.72,"y":198.05440000000002},{"x":729.6544,"y":235.34400000000002},{"x":715.5904,"y":265.1232},{"x":703.8656000000001,"y":298.15680000000003},{"x":697.136,"y":324.56320000000005},{"x":691.4816000000001,"y":360.2912},{"x":689.5744,"y":396.8352},{"x":689.5744,"y":408.03200000000004},{"x":711.9744000000001,"y":408.03520000000003},{"x":711.9744000000001,"y":396.83200000000005},{"x":713.0144,"y":371.0656},{"x":716.1504,"y":345.1136},{"x":794.4352,"y":360.68800000000005},{"x":794.4352,"y":360.68800000000005},{"x":816.4064000000001,"y":365.0528},{"x":818.5920000000001,"y":354.0672},{"x":827.0528,"y":323.408},{"x":900.6912000000001,"y":353.90720000000005},{"x":900.6912000000001,"y":353.90720000000005},{"x":921.3856000000001,"y":362.4768},{"x":925.6704,"y":352.12800000000004},{"x":953.6672000000001,"y":311.5584},{"x":988.88,"y":288.9216},{"x":999.2288000000001,"y":284.6368},{"x":990.6592,"y":263.93919999999997},{"x":990.6592,"y":263.93919999999997},{"x":975.3504000000001,"y":226.98560000000003},{"x":971.0655999999999,"y":216.6368},{"x":971.0655999999999,"y":216.6368},{"x":955.7568,"y":179.68320000000003},{"x":951.472,"y":169.33440000000002},{"x":941.1232,"y":173.6192},{"x":908.8191999999999,"y":189.952},{"x":892.6655999999999,"y":165.78240000000002},{"x":892.6655999999999,"y":165.7792},{"x":880.2208,"y":147.15200000000002},{"x":880.2208,"y":147.15200000000002},{"x":874.1472,"y":138.06400000000002},{"x":835.8752000000001,"y":80.7904},{"x":858.4096,"y":67.7248},{"x":883.1360000000001,"y":55.696000000000005},{"x":933.7632,"y":37.6096},{"x":980.9792,"y":27.791999999999998},{"x":1030.544,"y":24.156800000000004},{"x":1082.7808000000002,"y":27.4688},{"x":1119.648,"y":34.291199999999996},{"x":1160.7423999999999,"y":46.547200000000004},{"x":1199.3568,"y":63.0144},{"x":1239.312,"y":85.952},{"x":1276.3328000000001,"y":113.856},{"x":1289.1392,"y":125.43360000000001},{"x":1260.9824,"y":153.59040000000002},{"x":1276.8192,"y":169.43040000000002},{"x":1305.0048,"y":141.24480000000003},{"x":1313.728,"y":150.8384},{"x":1343.5488000000003,"y":189.7184},{"x":1372.4992000000002,"y":241.4624},{"x":1392.4352,"y":295.712},{"x":1404.3776,"y":358.7776},{"x":1406.1408000000001,"y":405.9456},{"x":1401.6480000000001,"y":454.92160000000007},{"x":1390.5056000000002,"y":503.90720000000005},{"x":1373.0592000000001,"y":550.6560000000001},{"x":1349.6192,"y":594.5408000000001},{"x":1325.6671999999999,"y":578.5344},{"x":1340.9664000000002,"y":551.2608},{"x":1351.3952000000002,"y":528.48},{"x":1355.68,"y":518.1344},{"x":1334.9824,"y":509.56480000000005},{"x":1330.6976,"y":519.9104000000001},{"x":1324.1728,"y":534.6080000000001},{"x":1316.3552,"y":550.0096},{"x":1306.9856,"y":566.0512},{"x":1231.3728,"y":515.5296000000001},{"x":1222.0608,"y":509.30559999999997},{"x":1215.84,"y":518.6176},{"x":1206.0704,"y":532.1088},{"x":1196.2816,"y":543.7024},{"x":1168.2144,"y":515.6352},{"x":1152.3744,"y":531.4720000000001},{"x":1180.4416,"y":559.5392},{"x":1155.3600000000001,"y":579.0944000000001},{"x":1146.048,"y":585.3184},{"x":1152.2720000000002,"y":594.6272},{"x":1174.4928,"y":627.888},{"x":1174.4896,"y":627.888},{"x":1186.9376,"y":646.5120000000001},{"x":1196.2495999999999,"y":640.2912000000001},{"x":1219.328,"y":623.1680000000001},{"x":1232.5024000000003,"y":611.6},{"x":1260.9824,"y":640.08},{"x":1276.8192,"y":624.24},{"x":1248.5344000000002,"y":595.9552},{"x":1240.6144000000002,"y":588.0352},{"x":1232.6944,"y":580.1152000000001},{"x":1224.7744,"y":588.0352},{"x":1212.7520000000002,"y":599.3408000000001},{"x":1203.7696,"y":606.944},{"x":1192.9632,"y":615.2256000000001},{"x":1176.9536,"y":591.264},{"x":1191.5008,"y":579.6768000000001},{"x":1208.5344000000002,"y":563.4784},{"x":1228.0064,"y":540.224},{"x":1310.2880000000002,"y":595.2032},{"x":1313.3696,"y":597.2672},{"x":1313.3696,"y":597.2672},{"x":1337.1456,"y":613.152},{"x":1317.9360000000001,"y":637.9680000000001},{"x":1281.1743999999999,"y":675.5744},{"x":1249.8944000000001,"y":700.432},{"x":1227.7792000000002,"y":667.328},{"x":1209.1552,"y":679.7760000000001},{"x":1231.2608,"y":712.8576},{"x":1191.8304,"y":734.3712},{"x":1151.6671999999999,"y":750.3808},{"x":1117.2224,"y":759.9744000000001},{"x":1099.4944,"y":670.8448000000001},{"x":1077.5264,"y":675.2128},{"x":1095.2351999999998,"y":764.2368000000001},{"x":1066.6976,"y":767.9488000000001},{"x":1029.6928,"y":769.3568},{"x":998.4128000000001,"y":767.696},{"x":962.9760000000001,"y":762.6272},{"x":923.2128000000001,"y":752.7104},{"x":901.392,"y":745.2096},{"x":912.3552,"y":718.7424000000001},{"x":937.68,"y":727.1936000000001},{"x":966.4639999999999,"y":734.2208},{"x":977.4495999999999,"y":736.4064000000001},{"x":981.8208000000001,"y":714.4384},{"x":970.8352,"y":712.2528000000001},{"x":937.5296000000001,"y":703.7504},{"x":910.5024,"y":693.9520000000001},{"x":900.1568,"y":689.6640000000001},{"x":895.872,"y":700.0096},{"x":880.6880000000001,"y":736.6688},{"x":848.1568,"y":720.1856},{"x":801.2288000000001,"y":688.368},{"x":778.0096,"y":668.2368000000001},{"x":842.3744000000002,"y":603.8752000000001},{"x":826.5344000000001,"y":588.0352},{"x":762.0448000000001,"y":652.5216},{"x":754.1248,"y":660.4448000000001},{"x":746.2048,"y":668.3648000000001},{"x":754.1248,"y":676.2848},{"x":802.9376000000001,"y":717.7376},{"x":837.6544,"y":739.9808},{"x":874.0416000000001,"y":758.2624000000001},{"x":911.2896000000001,"y":772.4256},{"x":949.6128000000001,"y":782.7456000000001},{"x":988.6880000000001,"y":789.1904000000001},{"x":1028.1984,"y":791.7280000000001},{"x":1056.336,"y":791.1392000000001},{"x":1085.9328000000003,"y":788.3584000000001},{"x":1118.0416000000002,"y":782.768},{"x":1154.2432000000001,"y":773.0944000000001},{"x":1176.6464,"y":765.1904000000001},{"x":1200.3136000000002,"y":755.1232},{"x":1229.8848,"y":739.8304},{"x":1253.1296000000002,"y":725.4336000000001},{"x":1286.592,"y":700.448},{"x":1327.2096000000001,"y":661.3984},{"x":1381.6896000000002,"y":583.7792000000001},{"x":1400.9984000000002,"y":541.9968},{"x":1414.4416,"y":501.59680000000003},{"x":1423.2992000000002,"y":461.2192},{"x":1427.6128,"y":424.86719999999997},{"x":1428.6112000000003,"y":391.2576},{"x":1426.8608000000002,"y":358.69440000000003},{"x":1422.9696000000001,"y":329.46880000000004},{"x":1416.0384000000001,"y":297.2448},{"x":1397.4272,"y":242.5024},{"x":1382.2688,"y":210.81920000000002},{"x":1362.1632,"y":177.2768},{"x":1338.4160000000002,"y":145.3088},{"x":1312.9536,"y":117.2672},{"x":1281.8304,"y":89.3024},{"x":1246.464,"y":63.8944},{"x":1212.9887999999999,"y":44.796800000000005},{"x":1179.0752,"y":29.5424},{"x":1132.3104,"y":14.3648},{"x":1095.2032,"y":6.6624},{"x":1050.5248,"y":2.1439999999999997},{"x":1023.7632,"y":1.8656},{"x":961.1424,"y":8.336},{"x":922.4128000000001,"y":17.552000000000003},{"x":865.3952000000002,"y":39.174400000000006},{"x":814.0192000000001,"y":68.24},{"x":749.2736,"y":122.272}]},
      {"instance":"PolygonObject","points":[{"x":1033.0368,"y":332.8672},{"x":1016.0064000000001,"y":335.1904},{"x":994.7776,"y":345.744},{"x":976.4832000000001,"y":367.6256},{"x":969.6384,"y":396.26880000000006},{"x":976.3424,"y":424.63360000000006},{"x":988.2272000000002,"y":441.07520000000005},{"x":1007.1456000000001,"y":454.14080000000007},{"x":1033.0368,"y":459.6704},{"x":1059.2160000000001,"y":454.0096},{"x":1077.8496,"y":441.07520000000005},{"x":1091.4464,"y":420.92160000000007},{"x":1096.4384,"y":396.26880000000006},{"x":1092.1664,"y":373.3824},{"x":1079.4815999999998,"y":353.15200000000004},{"x":1033.0368,"y":332.8672}]}
      ],
    "globals":{"maskcolor":"rgba(44,62,80,1)"}
  };

  scene = Scene.fromJson(ctx, obj);
  window.scene = scene;

  scene.lights.forEach(function(item){
    items.push(item);
  });
  scene.objects.forEach(function(item){
    items.push(item);
  });

  setSelection(null);



  // controls
  $lightorientation.change(function(e, o){
    if (o) {
      scene.setOption("angle", o.angle);
      scene.setOption("roughness", o.roughness);
    }
  }).hemiOrientationPicker($('.light-color'));
}

function createInstanceFor (cl) {
  switch (cl) {
    case "Lamp":
      return getRandomLight();
    case "DiscObject":
      return new DiscObject({ 
        center: new Vec2(), 
        radius: Math.round(30+10*Math.random())
      });
    case "RectangleObject":
      var dx = 30+Math.round(Math.random()*20);
      var dy = 20+Math.round(Math.random()*10);
      var d = new Vec2(dx, dy);
      return new RectangleObject({ topleft: new Vec2().sub(d), bottomright: new Vec2().add(d) });
  }
}

function bind () {
  var ext = illuminated.extractColorAndAlpha(scene.getMaskColor());
  $maskcolor.val(ext.color);
  $maskalpha.val(ext.alpha);
  if (!supportsColor) {
    $maskcolor.spectrum("set", ext.color);
  }

  $maskcolor.add($maskalpha).change(function(){
    var color = $maskcolor.val();
    var alpha = Math.round(parseFloat($maskalpha.val())*100)/100;
    scene.setMaskColor( illuminated.getRGBA(color, alpha) );
  });

  $lightcolor.add($lightalpha).change(function(){
    var color = $lightcolor.val();
    var alpha = Math.round(parseFloat($lightalpha.val())*100)/100;
    scene.setOption("color", illuminated.getRGBA(color, alpha) );
  });

  $('.bind-selection input[data-bind-option]').change(function(){
    scene.setOption($(this).attr("data-bind-option"), parseFloat($(this).val()));
  });

  $('.actions button.duplicate').click(function(){
    duplicateSelection();
  });
  $('.actions button.delete').click(function(){
    removeSelection();
  });
  $('.actions button.prev').click(function(){
    prevSelection();
  });
  $('.actions button.next').click(function(){
    nextSelection();
  });

  var title = $("title").text();
  scene.onChange(function () {
    dirty = true;
  });
  scene.triggerChange();

  $('input').live("focus", function() {
    canvasHashFocus = false;
  }).live("blur", function() {
    canvasHashFocus = true;
  });

  $("#toolbox a").click(function(e){
    e.preventDefault();
  });

  $(window).bind("mousedown", function (e) {
    mousedownItemNew = false;
    oldmousedown = mousedown;
    var p = positionWithE(e, canvas);
    mousedown = p = mousep = new Vec2(p.x, p.y);
    var inBound = p.inBound(new Vec2(0,0), new Vec2(canvas.width, canvas.height));
    var target = $(e.target);
    if (target.is("canvas")) {
      e.preventDefault();
      if (inBound && !buildPoly) {
        noSelection();
      }
    }
    if (target.is("#toolbox a img")) {
      e.preventDefault();
      var cl = target.attr("data-class");
      selectTool(cl, target);
      var item = createInstanceFor(cl);
      if (item) {
        moveItemDelta = p.inv();
        mousedownItem = item;
        mousedownItemNew = true;
      }
    }
    
    if (inBound) {
      var item = getItemAt(p);
      if (item) {
        e.preventDefault();
        moveItemDelta = new Vec2(0,0);
        mousedownItem = item;
        setSelection(item);
      }
      else {
        if(currentToolSelected=="PolygonObject") {
          e.preventDefault();
          addPolygonPoint(p);
        }
      }
    }
    dirty = true;
  });

  $(window).bind("mousemove", function (e) {
    var p = positionWithE(e, canvas);
    p = mousep = new Vec2(p.x, p.y);
    var inBound = p.inBound(new Vec2(0,0), new Vec2(canvas.width, canvas.height));
    if (mousedown) {
      if (mousedownItem) {
        if (inBound && items.indexOf(mousedownItem)==-1) {
          if (mousedownItem instanceof Light) {
            items.push(mousedownItem);
            scene.addLight(mousedownItem);
            setSelection(mousedownItem);
          }
          else if (mousedownItem instanceof OpaqueObject) {
            items.push(mousedownItem);
            scene.addObject(mousedownItem);
            setSelection(mousedownItem);
          }
          selectTool(null);
        }
        e.preventDefault();
        var diff = p.sub(mousedown);
        var v = diff.sub(moveItemDelta);
        moveItemDelta = diff;
        move (mousedownItem, v);
      }
    }
    dirty = true;
  });

  $(window).bind("mouseup", function (e) {
    var p = positionWithE(e, canvas);
    p = new Vec2(p.x, p.y);
    var positionChanged = mousedown && (p.dist2(mousedown) != 0);
    //scene.setOption("position", new Vec2(p.x, p.y));
    var inBound = p.inBound(new Vec2(0,0), new Vec2(canvas.width, canvas.height));
    var item;
    if (inBound) {
      item = getItemAt(p);
      if (!item) {
        if(positionChanged && buildPoly && currentToolSelected=="PolygonObject") {
          e.preventDefault();
          addPolygonPoint(p);
        }
      }
    }
 
    if (!mousedownItemNew || oldmousedown || positionChanged) {
      mousedown = null;
      mousedownItem = null;
    }
    dirty = true;
  });
}

function getSelectionRadiusForLight (l) {
  return Math.max(10, l.radius||0);
}

function getRandomLightColor () {
  var r = Math.round(230+25*Math.random());
  var g = Math.round(180+30*Math.random());
  var b = Math.round(130+20*Math.random());
  var a = 0.7+0.2*Math.random();
  return 'rgba('+[r,g,b,a]+')';
}

function getRandomLight () {
  return new Lamp({
    distance: 300,
    color: "rgba(255,255,255,0.7)",
    radius: 0,
    samples: 20
  });
}

function syncControls (item) {
  if (!item) {
    $lightcontrols.hide();
    $objectcontrols.hide();
  }
  else if (item instanceof Light) {
    $lightcontrols.show();
    $objectcontrols.hide();
    $lightorientation.trigger("change", {
      angle: item.angle,
      roughness: item.roughness
    });
    var ext = illuminated.extractColorAndAlpha(item.color);
    $lightcolor.val(ext.color);
    if (!supportsColor) {
      $lightcolor.spectrum("set", ext.color);
    }
    $lightalpha.val(ext.alpha);
    $lightdiffuse.val(item.diffuse);
    $lightsize.val(item.radius);
    $lightsamples.val(item.samples);
    $lightdistance.val(item.distance);
  }
  else if (item instanceof OpaqueObject) {
    $lightcontrols.hide();
    $objectcontrols.show();
    $objectdiffuse.val(item.diffuse===undefined ? 0.8 : item.diffuse); //FIXME
    $circlecontrols.hide();
    if (item instanceof DiscObject) {
      $circlecontrols.show();
      $discradius.val(item.radius);
    }
  }
}

function noSelection () {
  setSelection(null);
}

function setSelection (item) {
  currentSelect = items.indexOf(item);
  syncControls(item);
  scene.select(item);
}

function nextSelection () {
  var selection = items[(currentSelect >= items.length-1) ? 0 : currentSelect+1];
  setSelection(selection);
}

function prevSelection () {
  var selection = items[(currentSelect <= 0) ? items.length-1 : currentSelect-1];
  setSelection(selection);
}

function removeSelection () {
  removeItem(items[currentSelect]);
  noSelection();
}

function duplicateSelection () {
  var item = items[currentSelect];
  item = cloneItem(item);
  items.push(item);
  if (item instanceof OpaqueObject)
    scene.addObject(item);
  else if (item instanceof Light)
    scene.addLight(item);
  setSelection(item);
  moveItemDelta = new Vec2();
  mousedownItem = item;
  mousedown = mousep;
}

function cloneItem (o) {
  if (o instanceof Lamp) {
    return Lamp.fromJson(o.toJson());
  }
  else if (o instanceof PolygonObject) {
    return PolygonObject.fromJson(o.toJson());
  }
  else if (o instanceof DiscObject) {
    return DiscObject.fromJson(o.toJson());
  }
}

function removeItem (o) {
  var i = items.indexOf(o);
  if (i!=-1) items.splice(i, 1);
  if (o instanceof Light) {
    scene.removeLight(o);
  }
  else if (o instanceof OpaqueObject) {
    scene.removeObject(o);
  }
}

function move (item, delta) {
  if (item instanceof Light) {
    item.position = item.position.add(delta);
  }
  else if(item instanceof PolygonObject) {
    for (i=0; i<item.points.length; i++) {
      item.points[i] = item.points[i].add(delta);
    }
  }
  else if (item instanceof DiscObject) {
    item.center = item.center.add(delta);
  }
  $(item).change();
}


function getItemAt (p) {
  for (var i=0; i<items.length; ++i) {
    var item = items[i];
    if (item instanceof Light) {
      var c = item.position;
      var radius = getSelectionRadiusForLight(item);
      if (p && p.dist2(c) < radius*radius)
        return item;
    }
    else if(item instanceof OpaqueObject) {
      if (item.contains(p))
        return item;
    }
  }
}

function addPolygonPoint (p) {
  if (!buildPoly) {
    buildPoly = [ p ];
    syncControls(null);
  }
  else {
    if (buildPoly[0].dist2(p) < DIST_CLOSE*DIST_CLOSE) {
      if (buildPoly.length >= 2 && buildPoly[0].dist2(buildPoly[1])>=DIST_CLOSE*DIST_CLOSE) {
        var o = new PolygonObject({ points: buildPoly });
        scene.addObject(o);
        items.push(o);
        setSelection(o);
      }
      selectTool(null);
      buildPoly = null;
    }
    else {
      buildPoly.push(p);
    }
  }
  dirty = true;
}

function selectTool (cl, node) {
  currentToolSelected = cl;
  if (cl) {
    $tools.removeClass("selected");
    node.addClass("selected");
    var hoverText = node.attr("data-canvas-hoverText");
    if (hoverText) {
      $(canvas).attr("data-hoverText", hoverText);
    }
  }
  else {
    $tools.removeClass("selected");
    $(canvas).removeAttr("data-hoverText");
    hoverPopup.hide();
  }
}

var metal = new Image();
metal.onload = function(){ dirty = true }
metal.src = "images/blue.jpg";

function render () {
  if (!dirty) return; dirty = false;
  ctx.save();
  ctx.fillStyle = "#888";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  
  // DEBUG render
  for (var o=0; o<scene.objects.length; ++o) {
    ctx.save();
    var obj = scene.objects[0];
    ctx.beginPath();
    obj.path(ctx);
    ctx.clip();
    var bounds = obj.bounds();
    var topleft = bounds.topleft;
    ctx.drawImage(metal, topleft.x, topleft.y);
    ctx.restore();
    ctx.save();
    if (obj===scene.selected) {
      ctx.lineWidth = 2;
      ctx.strokeStyle = SELECTED_STROKE;
      ctx.beginPath();
      obj.path(ctx);
      ctx.stroke();
    }
    else {
      if ((scene.lights.length > 0) && mousedown && mousep && obj.contains(mousep)) {
          $('#alert').stop().velocity("transition.fadeIn", { duration: 1000 });
          delete scene.objects;
          setTimeout(function(){
            location.reload();
          }, 10000);
        ctx.lineWidth = 2;
        ctx.strokeStyle = HOVER_STROKE;
      } else if ((scene.lights.length > 0) && mousedown && mousep && scene.objects[1] && scene.objects[1].contains(mousep)) {
        $('#success').velocity("transition.expandIn").stop();
        var score = 45 - $('#count').text();
        $('#score').text(score);


        clearInterval(window.interval);
        delete scene.objects[1];
      }
      else {
        ctx.lineWidth = 1;
        ctx.strokeStyle = OBJECT_STROKE;
      }
      ctx.beginPath();
      obj.path(ctx);
      ctx.stroke();
    }
    ctx.restore();
  }

  scene.render(ctx);

  for (var o=0; o<scene.lights.length; ++o) {
    var light = scene.lights[o];
    var c = light.position;
    var radius = getSelectionRadiusForLight(light);
    if (light===scene.selected) {
      ctx.lineWidth = 2;
      ctx.strokeStyle = SELECTED_STROKE;
      ctx.beginPath();
      ctx.arc(c.x, c.y, radius, 0, 2*Math.PI); 
      ctx.stroke();
    }
    else if (mousep && mousep.dist2(c) < radius*radius) {
      ctx.lineWidth = 2;
      ctx.strokeStyle = HOVER_STROKE;
      ctx.beginPath();
      ctx.arc(c.x, c.y, radius, 0, 2*Math.PI); 
      ctx.stroke();
    }
  }

  ctx.strokeStyle="rgba(200,0,0,0.9)";
  ctx.lineWidth = 1;
  if (buildPoly) {
    ctx.beginPath();
    ctx.moveTo(buildPoly[0].x, buildPoly[0].y);
    for (var i=1; i<buildPoly.length; ++i) {
      var p = buildPoly[i];
      ctx.lineTo(p.x, p.y);
    }
    ctx.lineTo(mousep.x, mousep.y);
    ctx.stroke();
    if (buildPoly[0].dist2(mousep) < DIST_CLOSE*DIST_CLOSE) {
      ctx.fillStyle = "rgba(200,0,0,0.2)";
      ctx.fill();
      ctx.fillStyle = "rgba(200,0,0,0.5)";
      ctx.beginPath();
      ctx.arc(buildPoly[0].x, buildPoly[0].y, DIST_CLOSE-2, 0, Math.PI*2);
      ctx.fill();
    }
  }

  ctx.restore();
}


init();
bind();
requestAnimFrame(function loop(){
  requestAnimFrame(loop, canvas);
  render();
}, canvas);

}());
